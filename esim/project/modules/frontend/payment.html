<!DOCTYPE html>
<html>
<head>
    <title>Payment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .payment-container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            width: 360px;
        }

        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        .card-group,
        .expiry-group {
            display: flex;
            justify-content: space-between;
        }

        .card-group input {
            width: 60px;
            text-align: center;
        }

        .expiry-group input {
            width: 45%;
            text-align: center;
        }

        input {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .buttons {
            margin-top: 15px;
            text-align: center;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .cancel {
            background-color: #6c757d;
            color: white;
        }

        .proceed {
            background-color: #28a745;
            color: white;
        }

        .error {
            color: red;
            font-size: 13px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            width: 300px;
        }

        .modal-content button {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>

<div class="payment-container">
    <h2>Payment</h2>

    <!-- Card Number -->
    <label>Card Number</label>
    <div class="card-group">
        <input type="text" maxlength="4" id="card1">
        <input type="text" maxlength="4" id="card2">
        <input type="text" maxlength="4" id="card3">
        <input type="text" maxlength="4" id="card4">
    </div>

    <!-- Expiry -->
    <label>Expiry (MM / YY)</label>
    <div class="expiry-group">
        <input type="text" maxlength="2" placeholder="MM" id="expMonth">
        <input type="text" maxlength="2" placeholder="YY" id="expYear">
    </div>

    <!-- Name -->
    <input type="text" id="cardName" placeholder="Cardholder Name">

    <!-- CVV -->
    <input type="text" maxlength="3" id="cvv" placeholder="CVV">

    <div class="error" id="error-message"></div>

    <div class="buttons">
        <button class="cancel" onclick="goBack()">Cancel</button>
        <button class="proceed" onclick="processPayment()">Proceed</button>
    </div>
</div>

<!-- Success Modal -->
<div class="modal" id="successModal">
    <div class="modal-content">
        <h3>Payment Successful</h3>
        <button onclick="goToPlans()">Go to MyPlans</button>
    </div>
</div>

<script>
    // Auto move to next input
    document.querySelectorAll("input").forEach((input, index, arr) => {
        input.addEventListener("input", () => {
            if (input.value.length === input.maxLength && arr[index + 1]) {
                arr[index + 1].focus();
            }
        });
    });

    function validateInputs() {
        const c1 = document.getElementById("card1").value;
        const c2 = document.getElementById("card2").value;
        const c3 = document.getElementById("card3").value;
        const c4 = document.getElementById("card4").value;
        const month = document.getElementById("expMonth").value;
        const year = document.getElementById("expYear").value;
        const name = document.getElementById("cardName").value.trim();
        const cvv = document.getElementById("cvv").value;
        const error = document.getElementById("error-message");

        const digit4 = /^\d{4}$/;
        const digit2 = /^\d{2}$/;
        const nameRegex = /^[A-Za-z ]+$/;
        const cvvRegex = /^\d{3}$/;

        if (!digit4.test(c1) || !digit4.test(c2) || !digit4.test(c3) || !digit4.test(c4)) {
            error.textContent = "Card number must be 16 digits (4 per box).";
            return false;
        }

        if (!digit2.test(month) || parseInt(month) < 1 || parseInt(month) > 12) {
            error.textContent = "Invalid expiry month.";
            return false;
        }

        if (!digit2.test(year)) {
            error.textContent = "Invalid expiry year.";
            return false;
        }

        if (!nameRegex.test(name)) {
            error.textContent = "Name must contain English letters only.";
            return false;
        }

        if (!cvvRegex.test(cvv)) {
            error.textContent = "CVV must be 3 digits.";
            return false;
        }

        error.textContent = "";
        return true;
    }

    async function processPayment() {
        const username = localStorage.getItem("username");
        const cart = JSON.parse(localStorage.getItem(`cart_${username}`)) || [];
        if (!validateInputs()) return;

        if (cart.length === 0) {
            alert("Cart is empty.");
            return;
        }

        for (const item of cart) {
            for (let i = 0; i < item.quantity; i++) {
                await fetch("/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: username,
                        country: item.country,
                        data: item.data,
                        duration: item.duration,
                        status: "new",
                        data_remaining: item.data,
                        expires_at: null
                    })
                });
        }}

        localStorage.removeItem(`cart_${username}`);

        document.getElementById("successModal").style.display = "flex";
    }

    function goBack() {
        window.location.href = "cart.html";
    }

    function goToPlans() {
        window.location.href = "myplans.html";
    }
</script>

</body>
</html>